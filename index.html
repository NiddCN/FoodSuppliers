<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Leaflet and DataTables CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    
    <title>Sheffield Region Food Providers</title>
    
    <style>
        html, body, #map {
            width: 100%;
            height: 80%; 
            padding: 0;
            margin: 0;
        }
        #data-table {
            width: 100%;
            height: 20%;
            margin-top: 10px;
            border-collapse: collapse;
        }
        #data-table th, #data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #data-table th {
            background-color: #f2f2f2;
        }
        #table-container {
            height: 20%;
            overflow-y: auto; /* Allow table to be scrollable */
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Container for the table -->
    <div id="table-container">
        <table id="data-table" class="display">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Category</th>
                    <th>Website</th>
                    <th>Email</th>
                    <th>Contact Number</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added dynamically -->
            </tbody>
        </table>
    </div>

    <!-- Leaflet, jQuery, DataTables, PapaParse JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var map = L.map('map').setView([53.3811, -1.4701], 9);

            L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            var categoryIcons = {
                "Ready to eat meals": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/readymeal.svg',
                "Specialist diet supplies": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/Halal.svg',
                "Frozen foods": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/frozenfood.svg',
                "Protein": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/protein.svg',
                "Dairy and milk products": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/dairy.svg',
                "Bakery": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/bread.svg'
            };

            var csvUrl = 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Data/FoodSuppliersData.csv';

            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: function (results) {
                    var data = results.data;
                    var tableBody = document.querySelector('#data-table tbody');

                    data.forEach(function (row) {
                        var lat = parseFloat(row.lat);
                        var lng = parseFloat(row.long);

                        if (!isNaN(lat) && !isNaN(lng)) {
                            var category = row.Category || 'Default';
                            var iconUrl = categoryIcons[category] || 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/default.svg';

                            var customIcon = L.icon({
                                iconUrl: iconUrl,
                                iconSize: [32, 32], 
                                iconAnchor: [16, 32], 
                                popupAnchor: [0, -32] 
                            });

                            var marker = L.marker([lat, lng], { icon: customIcon });
                            var popupContent = [];

                            if (row.Public && row.Public !== 'N/A') {
                                popupContent.push(row.Public);
                            }
                            if (row.Supplier && row.Supplier !== 'N/A') {
                                popupContent.push('<b>Supplier Name:</b> ' + row.Supplier);
                            }
                            if (row.Category && row.Category !== 'N/A') {
                                popupContent.push('<b>Category:</b> ' + row.Category);
                            }
                            if (row.Website && row.Website !== 'N/A') {
                                popupContent.push('<b>Website:</b> <a href="' + row.Website + '" target="_blank">' + row.Website + '</a>');
                            }
                            if (row.Email && row.Email !== 'N/A') {
                                popupContent.push('<b>Email:</b> <a href="mailto:' + row.Email + '">' + row.Email + '</a>');
                            }
                            if (row.ContactNum && row.ContactNum !== 'N/A') {
                                popupContent.push('<b>Contact Number:</b> ' + row.ContactNum);
                            }

                            marker.bindPopup(popupContent.join('<br>'));
                            marker.addTo(map);

                            // Add a row to the table
                            var tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${row.Supplier || 'N/A'}</td>
                                <td>${row.Category || 'N/A'}</td>
                                <td>${row.Website ? '<a href="' + row.Website + '" target="_blank">' + row.Website + '</a>' : 'N/A'}</td>
                                <td>${row.Email ? '<a href="mailto:' + row.Email + '">' + row.Email + '</a>' : 'N/A'}</td>
                                <td>${row.ContactNum || 'N/A'}</td>
                            `;
                            tableBody.appendChild(tr);
                        }
                    });

                    // Initialize DataTables
                    $('#data-table').DataTable();
                },
                error: function (err) {
                    console.error('Error fetching or parsing data:', err);
                }
            });
        });
    </script>
</body>
</html>
