<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
    <title>Sheffield Region Food Providers</title>
    
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* Main container holding map and table */
        #main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        /* Map body */
        #map {
            flex: 1;
            width: 100%;
        }

        /* Category filter panel*/
        #cat-filter-panel {
            position: absolute;
            top: 90px;
            left: 10px;
            z-index: 1000;
            background-color: white;
            padding: 5px;
            border-radius: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-family: 'Noto Sans', sans-serif;
            font-size: 12px;
            width: 160px;
        }
        /* Hygiene filter panel */
        #hyg-filter-panel {
            position: absolute;
            top: 10px;
            right: 1%;
            z-index: 1000;
            background-color: white;
            padding: 5px;
            border-radius: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-family: 'Noto Sans', sans-serif;
            font-size: 12px;
            width: 60px;
        }
        /* Table container at the bottom of the page */
        #table-container {
            width: 100%;
            max-height: 30%; /* Adjust the table height as needed */
            overflow-y: auto;
            border: 3px solid #ccc; /* Adds a border around the table */
            padding: 10px; /* Adds space between the table and the border */
            box-sizing: border-box; /* Ensures padding is included in the width/height calculation */
            background-color: white; /* Optional: gives a background color to the table container */
            margin-top: 10px; /* Adds some space above the table */
        }

        /* Table styling */
        #data-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Noto Sans', sans-serif;
        }

        #data-table th, #data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #data-table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <!-- Main container that holds the map and table -->
    <div id="main-container">
        <!-- Map container -->
        <div id="map"></div>

        <div id="cat-filter-panel">
            <h3>Category</h3>
            <form id="category-filter">
                <label><input type="checkbox" value="Fresh fruit and veg" checked> Fresh fruit and veg</label><br>
                <label><input type="checkbox" value="Dairy and milk products" checked> Dairy and milk products</label><br>
                <label><input type="checkbox" value="Protein" checked> Protein</label><br>
                <label><input type="checkbox" value="Bakery" checked> Bakery</label><br>
                <label><input type="checkbox" value="Ready to eat meals" checked> Ready to eat meals</label><br>
                <label><input type="checkbox" value="Specialist diet supplies" checked> Specialist diet supplies</label><br>
                <label><input type="checkbox" value="Frozen foods" checked> Frozen foods</label><br>
                <label><input type="checkbox" value="Catering Supplies" checked> Catering Supplies</label><br>
                <label><input type="checkbox" value="Waste" checked> Waste</label><br>
                <label><input type="checkbox" value="Drink" checked> Drink</label>
            </form>
        </div>
        <!-- Hygiene filter boxes -->
        <div id="hyg-filter-panel">
            <h3>Hygiene Rating</h3>
            <form id="hygiene-filter">
                <label><input type="checkbox" value="5" checked> 5</label><br>
                <label><input type="checkbox" value="4" checked> 4</label><br>
                <label><input type="checkbox" value="3" checked> 3</label><br>
                <label><input type="checkbox" value="2" checked> 2</label><br>
                <label><input type="checkbox" value="1" checked> 1</label><br>
            </form>
        </div>
        
        <!-- Table container below the map -->
        <div id="table-container">
            <table id="data-table" class="display">
                <thead>
                    <tr>
                        <th>Supplier Name</th>
                        <th>Category</th>
                        <th>Website</th>
                        <th>Email</th>
                        <th>Contact Number</th>
                        <th>Hygiene Rating</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Leaflet, jQuery, DataTables, PapaParse libraries  -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        /* Initialize all markers array */
        var allMarkers = []; 

        /* Add map centred on Sheffield */
        document.addEventListener('DOMContentLoaded', function () {
            var map = L.map('map').setView([53.3811, -1.4701], 10.2);

            L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            /* Links to the symbols of the different categories - stored in the same Github repo */
            var categoryIcons = {
                "Ready to eat meals": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/readymeal.svg',
                "Specialist diet supplies": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/Halal.svg',
                "Frozen foods": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/frozenfood.svg',
                "Protein": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/protein.svg',
                "Dairy and milk products": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/dairy.svg',
                "Bakery": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/bread.svg',
                "Catering Supplies": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/cateringsupplies.svg',
                "Waste": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/waste.svg',
                "Fresh fruit and veg": 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Symbols/fruitveg.svg'
            };

            /* URL of the csv file - stored in the same Github repo */
            var csvUrl = 'https://raw.githubusercontent.com/NiddCN/FoodSuppliers/main/Data/FoodSuppliersData.csv';

            /* Parsing each line of the csv to add to map and filter boxes */
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: function (results) {
                    var data = results.data;

                    /* Generate a marker for each supplier */
                    data.forEach(function (supplier) {
                        if (supplier.Latitude && supplier.Longitude) {
                            var iconUrl = categoryIcons[supplier.Category];
                            var markerIcon = L.icon({
                                iconUrl: iconUrl,
                                iconSize: [32, 32]
                            });

                            var marker = L.marker([supplier.Latitude, supplier.Longitude], { icon: markerIcon })
                                .bindPopup(`<b>${supplier.SupplierName}</b><br>Category: ${supplier.Category}<br>Website: <a href="${supplier.Website}" target="_blank">${supplier.Website}</a><br>Contact: ${supplier.ContactNumber}<br>Hygiene Rating: ${supplier.HygieneRating}`);

                            marker.addTo(map); 
                            allMarkers.push({ marker, supplier });

                            /* Adding row to the data table */
                            $('#data-table').DataTable().row.add([
                                supplier.SupplierName,
                                supplier.Category,
                                supplier.Website,
                                supplier.Email,
                                supplier.ContactNumber,
                                supplier.HygieneRating
                            ]).draw();
                        }
                    });

                    /* Filter functionality */
                    function filterMarkers() {
                        var selectedCategories = [];
                        var selectedHygiene = [];

                        /* Get selected categories */
                        $('#category-filter input[type="checkbox"]:checked').each(function () {
                            selectedCategories.push(this.value);
                        });

                        /* Get selected hygiene ratings */
                        $('#hygiene-filter input[type="checkbox"]:checked').each(function () {
                            selectedHygiene.push(this.value);
                        });

                        /* Remove all markers from the map */
                        allMarkers.forEach(function (item) {
                            map.removeLayer(item.marker);
                        });

                        /* Add markers based on selected filters */
                        allMarkers.forEach(function (item) {
                            var categoryMatch = selectedCategories.includes(item.supplier.Category);
                            var hygieneMatch = selectedHygiene.includes(item.supplier.HygieneRating);

                            if (categoryMatch && hygieneMatch) {
                                item.marker.addTo(map);
                            }
                        });
                    }

                    /* Event listener for checkbox changes */
                    $('#category-filter input[type="checkbox"], #hygiene-filter input[type="checkbox"]').on('change', filterMarkers);
                }
            });
        });
    </script>
</body>
</html>
